import { Blob } from '@google/genai';

/**
 * üéß Audio Utilities
 * ‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡∏ó‡∏≥‡∏´‡∏ô‡πâ‡∏≤‡∏ó‡∏µ‡πà "‡∏•‡πà‡∏≤‡∏°‡πÅ‡∏õ‡∏•‡∏†‡∏≤‡∏©‡∏≤" ‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á Browser ‡πÅ‡∏•‡∏∞ AI
 * ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏Ñ‡∏≠‡∏°‡∏û‡∏¥‡∏ß‡πÄ‡∏ï‡∏≠‡∏£‡πå‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç (Binary/Bytes) ‡πÅ‡∏ï‡πà‡∏Å‡∏≤‡∏£‡∏™‡πà‡∏á‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏ô‡πá‡∏ï‡∏ö‡∏≤‡∏á‡∏ó‡∏µ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° (Base64)
 */

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô 1: ‡πÅ‡∏õ‡∏•‡∏á Base64 (‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏°‡∏±‡πà‡∏ß‡πÜ) -> ‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡πÑ‡∏ö‡∏ô‡∏≤‡∏£‡∏µ (Uint8Array)
// ‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô: ‡∏£‡∏±‡∏ö‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏à‡∏≤‡∏Å AI ‡∏°‡∏≤‡πÄ‡∏•‡πà‡∏ô
export function base64ToUint8Array(base64: string): Uint8Array {
  const binaryString = atob(base64); // atob ‡∏Ñ‡∏∑‡∏≠‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô‡∏ñ‡∏≠‡∏î‡∏£‡∏´‡∏±‡∏™ Base64
  const len = binaryString.length;
  const bytes = new Uint8Array(len);
  for (let i = 0; i < len; i++) {
    bytes[i] = binaryString.charCodeAt(i);
  }
  return bytes;
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô 2: ‡πÅ‡∏õ‡∏•‡∏á ArrayBuffer (‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç) -> ‡πÄ‡∏õ‡πá‡∏ô Base64 (‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°)
// ‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô: ‡∏à‡∏∞‡∏™‡πà‡∏á‡πÑ‡∏ü‡∏•‡πå‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÑ‡∏õ‡∏´‡∏≤ AI (‡πÅ‡∏ï‡πà‡πÉ‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡∏≠‡∏≤‡∏à‡∏à‡∏∞‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡πÇ‡∏î‡∏¢‡∏ï‡∏£‡∏á‡∏ö‡πà‡∏≠‡∏¢‡∏ô‡∏±‡∏Å ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡πÄ‡∏£‡∏≤‡∏™‡πà‡∏á Blob)
export function arrayBufferToBase64(buffer: ArrayBuffer): string {
  let binary = '';
  const bytes = new Uint8Array(buffer);
  const len = bytes.byteLength;
  for (let i = 0; i < len; i++) {
    binary += String.fromCharCode(bytes[i]);
  }
  return btoa(binary); // btoa ‡∏Ñ‡∏∑‡∏≠‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏´‡∏±‡∏™‡πÄ‡∏õ‡πá‡∏ô Base64
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô 3: ‡∏™‡∏£‡πâ‡∏≤‡∏á Blob ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÅ‡∏ö‡∏ö PCM
// PCM (Pulse Code Modulation) ‡∏Ñ‡∏∑‡∏≠‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏î‡∏¥‡∏ö‡πÜ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡∏ö‡∏µ‡∏ö‡∏≠‡∏±‡∏î (‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÑ‡∏ü‡∏•‡πå .wav ‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏´‡∏±‡∏ß‡πÑ‡∏ü‡∏•‡πå)
// AI ‡∏ä‡∏≠‡∏ö‡∏Å‡∏¥‡∏ô PCM ‡πÄ‡∏û‡∏£‡∏≤‡∏∞‡∏õ‡∏£‡∏∞‡∏°‡∏ß‡∏•‡∏ú‡∏•‡πÄ‡∏£‡πá‡∏ß‡∏™‡∏∏‡∏î
export function createPcmBlob(data: Float32Array): Blob {
  const l = data.length;
  // Browser ‡∏≠‡∏±‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏°‡∏≤‡πÄ‡∏õ‡πá‡∏ô Float32 (-1.0 ‡∏ñ‡∏∂‡∏á 1.0)
  // ‡πÅ‡∏ï‡πà AI ‡∏ö‡∏≤‡∏á‡∏ó‡∏µ‡∏≠‡∏¢‡∏≤‡∏Å‡πÑ‡∏î‡πâ Int16 (-32768 ‡∏ñ‡∏∂‡∏á 32767) ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏ó‡∏µ‡πà
  const int16 = new Int16Array(l);
  for (let i = 0; i < l; i++) {
    // ‡∏Ñ‡∏π‡∏ì‡∏î‡πâ‡∏ß‡∏¢ 32768 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ç‡∏¢‡∏≤‡∏¢‡∏™‡πÄ‡∏Å‡∏•
    int16[i] = data[i] * 32768;
  }
  return {
    data: arrayBufferToBase64(int16.buffer), // ‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô Text ‡∏Å‡πà‡∏≠‡∏ô‡∏™‡πà‡∏á
    mimeType: 'audio/pcm;rate=16000', // ‡∏ö‡∏≠‡∏Å AI ‡∏ß‡πà‡∏≤‡∏ô‡∏µ‡πà‡∏Ñ‡∏∑‡∏≠‡πÄ‡∏™‡∏µ‡∏¢‡∏á PCM ‡∏ô‡∏∞ ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î 16000Hz
  };
}

// ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô 4: ‡πÅ‡∏õ‡∏•‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö (PCM Bytes) ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏•‡πà‡∏ô‡πÑ‡∏î‡πâ (AudioBuffer)
// ‡πÉ‡∏ä‡πâ‡∏ï‡∏≠‡∏ô: AI ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡∏¥‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤ ‡πÄ‡∏£‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏≠‡∏≤‡∏°‡∏≤‡πÉ‡∏™‡πà‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏Ç‡∏≠‡∏á Browser
export async function decodeAudioData(
  data: Uint8Array,
  ctx: AudioContext,
  sampleRate: number = 24000,
  numChannels: number = 1,
): Promise<AudioBuffer> {
  // ‡πÅ‡∏õ‡∏•‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô Int16
  const dataInt16 = new Int16Array(data.buffer);
  const frameCount = dataInt16.length / numChannels;
  
  // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏©‡πÄ‡∏õ‡∏•‡πà‡∏≤‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏•‡∏∑‡πà‡∏ô‡πÄ‡∏™‡∏µ‡∏¢‡∏á (AudioBuffer)
  const buffer = ctx.createBuffer(numChannels, frameCount, sampleRate);

  for (let channel = 0; channel < numChannels; channel++) {
    const channelData = buffer.getChannelData(channel);
    for (let i = 0; i < frameCount; i++) {
      // ‡∏´‡∏≤‡∏£ 32768.0 ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÅ‡∏õ‡∏•‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÄ‡∏õ‡πá‡∏ô Float (-1.0 ‡∏ñ‡∏∂‡∏á 1.0) ‡∏ó‡∏µ‡πà‡∏•‡∏≥‡πÇ‡∏û‡∏á‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à
      channelData[i] = dataInt16[i * numChannels + channel] / 32768.0;
    }
  }
  return buffer;
}